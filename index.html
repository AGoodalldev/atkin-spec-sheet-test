<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Atkin Custom Spec Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { background:#0f3a36; font-family: ui-sans-serif, system-ui; margin:0; }
    .wrap { max-width: 960px; margin: 24px auto; background:#f4f5f4; border-radius:16px; padding:20px 22px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .row { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    label { font-size:12px; color:#374151; display:block; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:12px; background:#fff; }
    .section { margin-top:16px; }
    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .actions { display:flex; gap:10px; margin-top:14px; }
    button { padding:8px 12px; border:1px solid #cbd5e1; border-radius:12px; background:#fff; cursor:pointer; }
    .pill { background:#dcfce7; border-color:#bbf7d0; }
    .msg { margin:10px 0; padding:10px 12px; border-radius:10px; border:1px solid #f59e0b; background:#fffbeb; color:#92400e; display:none; }
    .changed { outline:2px solid #f97316; background:#fff7ed; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Atkin Custom Spec Sheet</h1>

    <div id="status" class="msg"></div>

    <div class="row">
      <div><label>Serial Number</label><input id="serial"></div>
      <div><label>Customer Name</label><input id="customer"></div>
      <div><label>Contact Email</label><input id="email" type="email"></div>
      <div>
        <label>Model</label>
        <select id="model"><option>Loading...</option></select>
        <label style="display:flex;gap:6px;align-items:center;margin-top:6px;font-size:12px;">
          <input id="showCustomOnly" type="checkbox"> Show only custom models
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>RIGHT / LEFT</label>
        <select id="rightLeft"><option value="">Select…</option><option>RIGHT</option><option>LEFT</option></select>
      </div>
      <div>
        <label>Updated At</label>
        <input id="updatedAt" readonly>
      </div>
    </div>

    <div id="specs" class="section" style="display:none;">
      <h3 style="margin:0 0 8px;">Specifications</h3>
      <div id="specsGrid" class="grid"></div>
    </div>

    <div class="section">
      <label>Additional Notes</label>
      <textarea id="notes" rows="5" placeholder="Anything extra to capture…"></textarea>
    </div>

    <div class="actions">
      <button id="btnPrint">Print PDF</button>
      <a href="https://docs.google.com/spreadsheets/d/1pIU3AycF8uHF8pAtncp8hbvo9xY295iucBs8OtcQgrc/edit#gid=1234273116"
         target="_blank" rel="noreferrer">
        <button>Edit spec sheet (Google Sheets)</button>
      </a>
      <button id="btnSave" class="pill">Save as New Model</button>
      <button id="btnReset">Reset form</button>
    </div>
  </div>

  <script>
    let MODEL_PRESETS = {}, CUSTOM_MODELS = {}, GUITAR_SPECS = {};
    let baseline = {}, current = {}, dirty = new Set();

    const $ = id => document.getElementById(id);
    const msg = (t, ok=true)=>{ const s=$('status'); s.textContent=t; s.style.display='block'; s.style.borderColor= ok?'#86efac':'#fca5a5'; s.style.background= ok?'#ecfdf5':'#fef2f2'; s.style.color= ok?'#065f46':'#991b1b'; if(ok) setTimeout(()=>s.style.display='none',2500); };

    document.addEventListener('DOMContentLoaded', () => {
      bind();
      google.script.run.withSuccessHandler(init).withFailureHandler(e=>msg('Load failed: '+e.message,false)).apiListAll();
    });

    function bind(){
      $('btnPrint').onclick = printPdf;
      $('btnSave').onclick = saveAsNewModel;
      $('btnReset').onclick = () => location.reload();
      $('model').onchange = handleModelChange;
      $('showCustomOnly').onchange = populateModels;
      $('rightLeft').onchange = () => updateBadge();
    }

    function init(data){
      MODEL_PRESETS = data.models || {};
      CUSTOM_MODELS = data.custom || {};
      GUITAR_SPECS  = data.options || {};
      populateModels();
      msg(`Loaded ${Object.keys(MODEL_PRESETS).length} factory / ${Object.keys(CUSTOM_MODELS).length} custom / ${Object.keys(GUITAR_SPECS).length} fields`);
    }

    function populateModels(){
      const showCustom = $('showCustomOnly').checked;
      const src = showCustom ? CUSTOM_MODELS : MODEL_PRESETS;
      const sel = $('model');
      sel.innerHTML = '';
      sel.appendChild(new Option(showCustom?'Custom Model':'Factory Model',''));
      Object.keys(src).sort().forEach(n => sel.appendChild(new Option(n,n)));
      $('specs').style.display='none';
    }

    function handleModelChange(){
      const name = $('model').value;
      if (!name){ $('specs').style.display='none'; return; }
      const src = $('showCustomOnly').checked ? CUSTOM_MODELS : MODEL_PRESETS;
      const data = src[name]; if (!data) return msg(`No data for ${name}`, false);
      baseline = {...data}; current = {...data}; dirty.clear();
      $('updatedAt').value = new Date().toISOString();
      buildSpecsUI(data);
      $('specs').style.display='block';
    }

    function buildSpecsUI(modelData){
      const g = $('specsGrid'); g.innerHTML='';
      const fields = new Set([...Object.keys(GUITAR_SPECS), ...Object.keys(modelData)]);
      fields.forEach(field=>{
        const wrap = document.createElement('div');
        const options = GUITAR_SPECS[field];
        const val = modelData[field] ?? '';
        if (Array.isArray(options) && options.length){
          const sel = document.createElement('select');
          sel.id = `spec-${field}`; sel.onchange=()=>onSpec(field, sel.value, sel);
          sel.appendChild(new Option('Select…',''));
          options.forEach(o=>sel.appendChild(new Option(o,o)));
          if (val && !options.includes(val)) sel.appendChild(new Option(val,val));
          sel.value = val || '';
          wrap.innerHTML = `<label>${field}</label>`; wrap.appendChild(sel);
        }else{
          const i = document.createElement('input'); i.readOnly=true; i.value = val || '';
          wrap.innerHTML = `<label>${field}</label>`; wrap.appendChild(i);
        }
        g.appendChild(wrap);
        current[field] = val || '';
      });
    }
    function onSpec(field, value, sel){
      current[field] = value;
      const base = baseline[field] ?? '';
      if (value && value !== base){ dirty.add(field); sel.classList.add('changed'); }
      else { dirty.delete(field); sel.classList.remove('changed'); }
      if (dirty.size) msg(`${dirty.size} spec${dirty.size===1?'':'s'} modified`);
    }

    function printPdf(){
      // keep using the browser print (your A4 CSS lives server-side for Drive PDF)
      window.print();
    }

    async function saveAsNewModel(){
      // name prompt
      let name = prompt('Enter a name for the new model:');
      if (!name) return msg('Cancelled', false);
      name = name.trim();

      // existence check (CUSTOM only)
      try{
        const existsRes = await new Promise((res,rej)=>
          google.script.run.withSuccessHandler(res).withFailureHandler(rej).apiExists(name,'custom')
        );
        let overwrite = false;
        if (existsRes.exists){
          if (!confirm(`A custom model named "${name}" exists.\n\nOK = Overwrite\nCancel = Choose another`)){
            const alt = prompt('Enter a different name:', name + ' (copy)');
            if (!alt) return msg('Cancelled', false);
            name = alt.trim();
            const ex2 = await new Promise((res,rej)=>
              google.script.run.withSuccessHandler(res).withFailureHandler(rej).apiExists(name,'custom')
            );
            if (ex2.exists) return msg(`"${name}" already exists`, false);
          } else {
            overwrite = true;
          }
        }

        // build specs payload
        const specs = {
          ...current,
          Serial:   $('serial').value || '',
          Customer: $('customer').value || '',
          Email:    $('email').value || '',
          'RIGHT / LEFT': $('rightLeft').value || '',
          Notes: $('notes').value || '',
          'Updated At': new Date().toISOString(),
        };

        // save model (always to CUSTOM MODELS)
        const saved = await new Promise((res,rej)=>
          google.script.run.withSuccessHandler(res).withFailureHandler(rej)
            .apiSaveModel({ modelName:name, specs, overwrite })
        );
        if (!saved.ok) return msg('Save failed: '+(saved.error||'Unknown'), false);
        msg(`Model “${saved.name}” ${saved.action === 'updated' ? 'updated' : 'created'}`);

        // refresh lists
        const fresh = await new Promise((res,rej)=>
          google.script.run.withSuccessHandler(res).withFailureHandler(rej).apiListAll()
        );
        MODEL_PRESETS = fresh.models || {};
        CUSTOM_MODELS = fresh.custom || {};
        populateModels();
        $('model').value = saved.name; handleModelChange();

        // ask to save PDF to Drive
        if (confirm('Save PDF to Google Drive now?')){
          const serial = $('serial').value || saved.name;
          const pdf = await new Promise((res,rej)=>
            google.script.run.withSuccessHandler(res).withFailureHandler(rej)
              .apiSavePdf({ serial, modelName:saved.name, specs, fileName: serial })
          );
          if (pdf.ok){
            msg('PDF saved to Drive' + (pdf.replaced?' (overwritten)':'')); 
          } else {
            msg('PDF save failed: '+(pdf.error||'Unknown'), false);
          }
        }
      }catch(err){
        msg('Error: '+(err && err.message || err), false);
      }
    }

    function updateBadge(){ /* placeholder for printed badge if needed */ }
  </script>
</body>
</html>
