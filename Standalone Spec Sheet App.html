<script>
    // Configuration
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbzXM4ewfNZmBDi5gYszoLTZSvSWMaktHyvmvTaI3E-HcVy4_OKQIFwTWZHDbiEIlGOn/exec";
    
    // Global data storage
    let MODEL_PRESETS = {};
    let GUITAR_SPECS = {}; // Will be populated from API or fallback
    let currentSpecs = {};
    let baseline = {};
    let dirtyFields = new Set();

    // Initialize the application
    function init() {
        setupEventListeners();
        loadModelsFromAPI();
    }

    function setupEventListeners() {
        document.getElementById('model').addEventListener('change', handleModelChange);
    }

    function loadModelsFromAPI() {
        showStatus('Loading guitar models from Google Sheets...', 'info');
        
        const url = `${GAS_BASE}?kind=models&_cb=${Date.now()}`;
        console.log("📡 Loading models from:", url);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log("📦 API Response:", data);
                
                if (data.ok && data.data) {
                    MODEL_PRESETS = {};
                    
                    // Load all models except 'NA'
                    let modelCount = 0;
                    Object.keys(data.data).forEach(modelName => {
                        if (modelName && modelName !== 'NA' && modelName.trim() !== '') {
                            MODEL_PRESETS[modelName] = data.data[modelName];
                            modelCount++;
                        }
                    });
                    
                    console.log(`✅ Loaded ${modelCount} models successfully!`);
                    console.log("🎸 Sample models:", Object.keys(MODEL_PRESETS).slice(0, 5));
                    
                    // Generate GUITAR_SPECS from the models data
                    generateGuitarSpecs();
                    
                    // Populate the dropdown
                    populateModelDropdown();
                    showStatus(`✅ Loaded ${modelCount} guitar models from Google Sheets`, 'success');
                } else {
                    throw new Error("Invalid API response");
                }
            })
            .catch(error => {
                console.error('❌ Error loading models:', error);
                showStatus('❌ Failed to load models. Using fallback data.', 'warning');
                loadFallbackData();
            });
    }

    function generateGuitarSpecs() {
        // Extract all unique values for each field from all models
        GUITAR_SPECS = {};
        
        Object.values(MODEL_PRESETS).forEach(model => {
            Object.keys(model).forEach(field => {
                if (!GUITAR_SPECS[field]) {
                    GUITAR_SPECS[field] = new Set();
                }
                if (model[field] && model[field] !== '-' && model[field].trim() !== '') {
                    GUITAR_SPECS[field].add(model[field]);
                }
            });
        });
        
        // Convert Sets to Arrays
        Object.keys(GUITAR_SPECS).forEach(field => {
            GUITAR_SPECS[field] = Array.from(GUITAR_SPECS[field]).sort();
        });
        
        console.log("🔧 Generated specs for fields:", Object.keys(GUITAR_SPECS));
    }

    function populateModelDropdown() {
        const modelSelect = document.getElementById('model');
        if (!modelSelect) return;
        
        console.log("🔄 Populating model dropdown...");
        modelSelect.innerHTML = '<option value="">Choose a model</option>';
        
        const modelNames = Object.keys(MODEL_PRESETS).sort();
        modelNames.forEach(modelName => {
            const option = document.createElement('option');
            option.value = modelName;
            option.textContent = modelName;
            modelSelect.appendChild(option);
        });
        
        console.log(`✅ Dropdown populated with ${modelNames.length} models`);
    }

    function loadFallbackData() {
        // Fallback guitar specs and models
        GUITAR_SPECS = {
            "FINISH": ["AGED", "LIGHT RELIC", "HEAVY RELIC", "Natural", "Gloss", "Satin"],
            "TOP": ["STIKA SPRUCE", "MAHOGANY", "FLAME MAPLE", "Cedar", "Redwood"],
            "BACK / SIDES": ["MAHOGANY", "FLAME MAPLE", "Rosewood", "Walnut", "Maple"],
            "BACKSTRIP": ["CHECKER", "ZIPPER", "Herringbone", "Simple", "None"],
            "ROSETTE": ["B / W / B", "CREAM", "Abalone", "Wood", "Custom"],
            "BRACING": ["7MM / 15MM", "8MM / 20MM", "Standard", "Heavy", "Light"],
            "END WEDGE": ["IN RW", "BW IVORID BW", "Ebony", "Maple", "None"],
            "BINDINGS": ["CREAM", "TORT", "IVOROID", "Wood", "Plastic"],
            "PURFLING F/B": ["W BWB / -", "HERRING / BW", "Abalone", "Wood", "None"],
            "FRETBOARD": ["SANTOS", "EBONY", "Rosewood", "Maple", "Pau Ferro"],
            "NUT WIDTH": ["43", "45", "42", "44", "46"],
            "F/BOARD INLAYS": ["6MM DOTS", "DIAMOND", "Blocks", "None", "Custom"],
            "SCALE": ["SHORT 24.9", "LONG 25.4", "Standard", "Custom"],
            "NECK SHAPE": ["VINTAGE V", "PRE WAR", "Modern C", "Thin C", "Custom"],
            "HEADSTOCK VENEER": ["EBONY", "MAPLE", "Rosewood", "Matching Body"],
            "HEADSTOCK INLAY": ["LOGO", "LOGO HESDSTOCK", "Name", "Custom", "None"],
            "HS DECAL": ["LOGO BANNER", "LOGO", "Name", "Custom", "None"],
            "BODY JOIN": ["14", "13", "12", "15"],
            "M/HEADS": ["NICKEL KLUSON", "NICKEL GOTOH", "Gold", "Chrome", "Vintage"],
            "FRETS": ["G STYLE", "M STYLE", "Jumbo", "Medium", "Small"],
            "BRIDGE STYLE": ["SANTOS", "EBONY", "Rosewood", "Maple"],
            "BRIDGE WOOD": ["SANTOS", "EBONY", "Rosewood", "Maple"],
            "PICKGUARD": ["TORT", "FIRE STRIPE", "Black", "White", "None"],
            "BRIDGE PINS": ["CREAM", "EBONY", "Bone", "Plastic"],
            "END PIN": ["CREAM", "BLACK", "Ebony", "Bone"],
            "STRINGS": ["12's", "11's", "13's", "10's"],
            "PICKUP": ["None", "Magnetic", "Piezo", "Both"]
        };

        MODEL_PRESETS = {
            "J43": {
                "FINISH": "AGED",
                "TOP": "STIKA SPRUCE",
                "BACK / SIDES": "MAHOGANY",
                "BACKSTRIP": "CHECKER",
                "ROSETTE": "B / W / B",
                "BRACING": "7MM / 15MM",
                "END WEDGE": "IN RW",
                "BINDINGS": "CREAM",
                "PURFLING F/B": "W BWB / -",
                "FRETBOARD": "SANTOS",
                "NUT WIDTH": "43",
                "F/BOARD INLAYS": "6MM DOTS",
                "SCALE": "SHORT 24.9",
                "NECK SHAPE": "VINTAGE V",
                "HEADSTOCK VENEER": "EBONY",
                "HEADSTOCK INLAY": "LOGO",
                "HS DECAL": "LOGO BANNER",
                "BODY JOIN": "14",
                "M/HEADS": "NICKEL KLUSON",
                "FRETS": "G STYLE",
                "BRIDGE STYLE": "SANTOS",
                "BRIDGE WOOD": "SANTOS",
                "PICKGUARD": "TORT",
                "BRIDGE PINS": "CREAM",
                "END PIN": "CREAM",
                "STRINGS": "12's"
            },
            "L36": {
                "FINISH": "LIGHT RELIC",
                "TOP": "MAHOGANY",
                "BACK / SIDES": "FLAME MAPLE",
                "BACKSTRIP": "ZIPPER",
                "ROSETTE": "CREAM",
                "BRACING": "8MM / 20MM",
                "END WEDGE": "BW IVORID BW",
                "BINDINGS": "TORT",
                "PURFLING F/B": "HERRING / BW",
                "FRETBOARD": "EBONY",
                "NUT WIDTH": "45",
                "F/BOARD INLAYS": "DIAMOND",
                "SCALE": "LONG 25.4",
                "NECK SHAPE": "PRE WAR",
                "HEADSTOCK VENEER": "MAPLE",
                "HEADSTOCK INLAY": "LOGO HESDSTOCK",
                "HS DECAL": "LOGO",
                "BODY JOIN": "13",
                "M/HEADS": "NICKEL GOTOH",
                "FRETS": "M STYLE",
                "BRIDGE STYLE": "EBONY",
                "BRIDGE WOOD": "EBONY",
                "PICKGUARD": "FIRE STRIPE",
                "BRIDGE PINS": "EBONY",
                "END PIN": "BLACK",
                "STRINGS": "11's"
            }
        };
        
        populateModelDropdown();
    }

    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    }

    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('statusMessage');
        const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
                       type === 'warning' ? 'bg-amber-50 border-amber-200 text-amber-800' :
                       type === 'error' ? 'bg-red-50 border-red-200 text-red-700' :
                       'bg-blue-50 border-blue-200 text-blue-800';
        
        statusDiv.className = `flex items-center gap-2 p-3 border rounded-xl ${bgColor}`;
        statusDiv.innerHTML = `<span>${message}</span>`;
        statusDiv.classList.remove('hidden');
        
        if (type === 'info' || type === 'success') {
            setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        }
    }

    function handleModelChange(event) {
        const selectedModel = event.target.value;
        if (!selectedModel) {
            hideSpecs();
            return;
        }
        
        const preset = MODEL_PRESETS[selectedModel] || {};
        baseline = { ...preset };
        currentSpecs = { ...preset };
        dirtyFields.clear();
        
        console.log(`🎸 Selected model: ${selectedModel}`, preset);
        
        showSpecs();
        populateSpecs(preset);
    }

    function showSpecs() {
        document.getElementById('specsSection').classList.remove('hidden');
    }

    function hideSpecs() {
        document.getElementById('specsSection').classList.add('hidden');
    }

    function populateSpecs(preset) {
        const specsGrid = document.getElementById('specsGrid');
        specsGrid.innerHTML = '';
        
        // Create field mapping for better display names
        const fieldMapping = {
            'SCALE': 'Scale Length',
            'NUT WIDTH': 'Nut Width', 
            'NECK SHAPE': 'Neck Shape',
            'HEADSTOCK VENEER': 'Headstock Veneer',
            'HS DECAL': 'Headstock Decal',
            'HEADSTOCK INLAY': 'Headstock Inlay',
            'FRETBOARD': 'Fretboard',
            'F / BOARD INLAYS': 'Fretboard Inlays',
            'BRIDGE STYLE': 'Bridge Style',
            'BRIDGE WOOD': 'Bridge Wood',
            'TOP': 'Top Wood',
            'BACK / SIDES': 'Back & Sides',
            'BINDINGS': 'Bindings',
            'PURFLING F / B': 'Purfling',
            'BACKSTRIP': 'Backstrip',
            'END WEDGE': 'End Wedge',
            'FRETS': 'Frets',
            'BRACING': 'Bracing',
            'ROSETTE': 'Rosette',
            'MACHINEHEADS': 'Machine Heads',
            'PICKGUARD': 'Pickguard',
            'BRIDGE PINS': 'Bridge Pins',
            'END PIN': 'End Pin',
            'STRINGS': 'Strings',
            'BODY JOIN': 'Body Join'
        };
        
        // Use the appropriate field names based on what we have in GUITAR_SPECS
        const availableFields = Object.keys(GUITAR_SPECS);
        
        availableFields.forEach(field => {
            if (GUITAR_SPECS[field] && GUITAR_SPECS[field].length > 0) {
                const fieldDiv = document.createElement('div');
                const options = GUITAR_SPECS[field];
                const displayName = fieldMapping[field] || field;
                
                fieldDiv.innerHTML = `
                    <label for="spec-${field}" class="text-sm font-medium text-gray-700 mb-1 block">${displayName}</label>
                    <div id="container-${field}">
                        <select id="spec-${field}" 
                                class="w-full border rounded-2xl px-4 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-black/20 transition-all appearance-none"
                                onchange="handleSpecChange('${field}', this.value)">
                            <option value="">Select...</option>
                            ${options.map(option => 
                                `<option value="${option}" ${preset[field] === option ? 'selected' : ''}>${option}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
                specsGrid.appendChild(fieldDiv);
            }
        });
    }

    function handleSpecChange(field, value) {
        currentSpecs[field] = value;
        
        const baseValue = baseline[field] || '';
        const container = document.getElementById(`container-${field}`);
        
        if (value !== baseValue) {
            dirtyFields.add(field);
            container.classList.add('highlight-changed');
        } else {
            dirtyFields.delete(field);
            container.classList.remove('highlight-changed');
        }
    }

    function printPdf() {
        window.print();
    }

    function softReset() {
        document.getElementById('customer').value = '';
        document.getElementById('email').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('model').value = '';
        document.getElementById('rightLeft').value = '';
        
        currentSpecs = {};
        baseline = {};
        dirtyFields.clear();
        hideSpecs();
        
        showStatus('Form reset successfully', 'success');
    }

    function hardReset() {
        const btn = document.getElementById('hardResetBtn');
        btn.innerHTML = '<div class="loading-spinner"></div> Reloading...';
        btn.disabled = true;
        
        MODEL_PRESETS = {};
        GUITAR_SPECS = {};
        
        setTimeout(() => {
            loadModelsFromAPI();
            btn.innerHTML = 'Hard reset (reload options)';
            btn.disabled = false;
        }, 1000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
</script>
